<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI CyberScan - 人臉辨識系統</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root { --neon-cyan: #00f3ff; --neon-red: #ff003c; }
        body {
            background-color: #0a0a0c;
            color: white;
            font-family: 'Orbitron', sans-serif;
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; overflow-x: hidden;
        }
        /* 燃燒紙張科技感外框 */
        .scanner-container {
            position: relative;
            background: #1a1a1e;
            padding: 30px;
            border: 2px solid var(--neon-cyan);
            box-shadow: 0 0 20px var(--neon-cyan);
            width: 90%; max-width: 800px;
            /* 模擬燃燒邊緣效果 */
            mask-image: radial-gradient(circle at center, black 80%, transparent 100%);
            clip-path: polygon(0% 15%, 15% 0%, 85% 0%, 100% 15%, 100% 85%, 85% 100%, 15% 100%, 0% 85%);
        }
        h2 { text-transform: uppercase; letter-spacing: 5px; color: var(--neon-cyan); text-shadow: 0 0 10px var(--neon-cyan); }
        .upload-zone {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;
        }
        input[type="file"] {
            background: #222; border: 1px solid var(--neon-cyan); color: white; padding: 10px; width: 80%;
        }
        #status { font-size: 0.9em; margin: 10px; color: #aaa; }
        .result-area {
            position: relative; border: 1px solid #333; background: #000;
            min-height: 300px; display: flex; justify-content: center; align-items: center;
        }
        canvas { position: absolute; top: 0; left: 0; }
        img { max-width: 100%; height: auto; }
        /* 科技流感動畫線條 */
        .scan-line {
            position: absolute; width: 100%; height: 2px; background: var(--neon-cyan);
            top: 0; left: 0; box-shadow: 0 0 15px var(--neon-cyan);
            animation: scan 3s linear infinite; display: none; z-index: 10;
        }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }
    </style>
</head>
<body>

<div class="scanner-container">
    <h2>Face Identification System</h2>
    <div id="status">INITIALIZING SYSTEM... ⏳</div>

    <div class="upload-zone">
        <div>
            <label>TARGET REF (基準人臉)</label><br>
            <input type="file" id="refImg" accept="image/*">
        </div>
        <div>
            <label>SCAN SOURCE (待掃描圖)</label><br>
            <input type="file" id="queryImg" accept="image/*">
        </div>
    </div>

    <div class="result-area" id="stage">
        <div class="scan-line" id="scannerLine"></div>
        <img id="mainView" src="https://via.placeholder.com/600x400/111/00f3ff?text=WAITING+FOR+DATA+INPUT">
    </div>
</div>

<script>
    // 解決可能的 CORS 問題，改用知名託管路徑
    const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models/';

    async function init() {
        try {
            const status = document.getElementById('status');
            await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);
            await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
            await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
            status.innerText = "SYSTEM READY. AWAITING INPUT...";
            status.style.color = "var(--neon-cyan)";
        } catch (err) {
            document.getElementById('status').innerText = "ERROR: MODEL LOAD FAILED.";
        }
    }

    async function runCompare() {
        const refFile = document.getElementById('refImg').files[0];
        const queryFile = document.getElementById('queryImg').files[0];
        if (!refFile || !queryFile) return;

        document.getElementById('status').innerText = "ANALYZING BIOMETRICS...";
        document.getElementById('scannerLine').style.display = "block";

        const refImage = await faceapi.bufferToImage(refFile);
        const refResult = await faceapi.detectSingleFace(refImage).withFaceLandmarks().withFaceDescriptor();

        if (!refResult) {
            alert("NO FACE DETECTED IN REFERENCE IMAGE!");
            return;
        }
        const faceMatcher = new faceapi.FaceMatcher(refResult, 0.55);

        const mainImg = document.getElementById('mainView');
        mainImg.src = URL.createObjectURL(queryFile);

        mainImg.onload = async () => {
            const oldCanvas = document.querySelector('canvas');
            if (oldCanvas) oldCanvas.remove();

            const detections = await faceapi.detectAllFaces(mainImg).withFaceLandmarks().withFaceDescriptors();
            const canvas = faceapi.createCanvasFromMedia(mainImg);
            document.getElementById('stage').appendChild(canvas);
            
            const displaySize = { width: mainImg.width, height: mainImg.height };
            faceapi.matchDimensions(canvas, displaySize);
            const resizedResults = faceapi.resizeResults(detections, displaySize);

            resizedResults.forEach(d => {
                const match = faceMatcher.findBestMatch(d.descriptor);
                const score = (1 - match.distance).toFixed(2);
                const isTarget = match.label !== 'unknown';

                const drawBox = new faceapi.draw.DrawBox(d.detection.box, { 
                    label: isTarget ? `MATCH: ${Math.round(score*100)}%` : 'NON-TARGET',
                    drawStyle: { color: isTarget ? '#00f3ff' : '#ff003c', lineWidth: 2 }
                });
                drawBox.draw(canvas);
            });
            document.getElementById('status').innerText = "SCAN COMPLETE.";
            document.getElementById('scannerLine').style.display = "none";
        };
    }

    document.getElementById('refImg').onchange = runCompare;
    document.getElementById('queryImg').onchange = runCompare;
    init();
</script>
</body>
</html>
