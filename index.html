<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 科技流人臉比對系統</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root { --neon-blue: #00d2ff; --neon-green: #39ff14; --neon-red: #ff3131; --bg-dark: #050505; }
        body {
            background-color: var(--bg-dark); color: white;
            font-family: 'Noto Sans TC', sans-serif; margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
        }
        /* 科技流矩形外框 */
        .main-container {
            width: 95%; max-width: 1100px; background: rgba(20, 20, 25, 0.8);
            border: 1px solid var(--neon-blue); padding: 20px;
            box-shadow: 0 0 15px rgba(0, 210, 255, 0.2); position: relative;
        }
        h1 { font-family: 'Share Tech Mono', sans-serif; color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        .layout { display: flex; gap: 20px; flex-wrap: wrap; }
        .control-panel { flex: 1; min-width: 300px; }
        .display-panel { flex: 2; min-width: 400px; text-align: center; position: relative; }

        /* 表格樣式 */
        .data-table {
            width: 100%; border-collapse: collapse; margin-top: 20px;
            font-size: 14px; background: rgba(255, 255, 255, 0.05);
        }
        .data-table th { background: var(--neon-blue); color: black; padding: 8px; }
        .data-table td { border: 1px solid #333; padding: 10px; text-align: center; cursor: pointer; transition: 0.3s; }
        .data-table tr:hover { background: rgba(0, 210, 255, 0.1); }

        /* 上傳區域 */
        .upload-box { border: 1px dashed #555; padding: 15px; margin-bottom: 15px; background: #111; }
        input[type="file"] { width: 100%; color: #888; margin-top: 5px; }

        /* 畫布容器 */
        .canvas-container { position: relative; display: inline-block; border: 1px solid #444; background: #000; }
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; }
        img { max-width: 100%; height: auto; display: block; }

        /* 閃爍動畫 */
        @keyframes flash {
            0%, 100% { opacity: 1; filter: brightness(1); }
            50% { opacity: 0.3; filter: brightness(3) drop-shadow(0 0 20px var(--neon-blue)); }
        }
        .flash-target { animation: flash 0.4s ease 3; border: 3px solid var(--neon-blue) !important; }
        
        #loading-overlay { color: var(--neon-green); font-family: 'Share Tech Mono'; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="main-container">
    <h1>CYBER_FACE_SCANNER v1.0</h1>
    <div id="loading-overlay">>> 系統初始化中...</div>

    <div class="layout">
        <div class="control-panel">
            <div class="upload-box">
                <label>【 基準目標照片 】</label>
                <input type="file" id="refImg" accept="image/*">
            </div>
            <div class="upload-box">
                <label>【 待掃描現場圖 】</label>
                <input type="file" id="queryImg" accept="image/*">
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>編號</th>
                        <th>判定標籤</th>
                        <th>相似度比例</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="resultBody">
                    <tr><td colspan="4">尚未掃描資料</td></tr>
                </tbody>
            </table>
        </div>

        <div class="display-panel">
            <div class="canvas-container" id="stage">
                <img id="mainView" src="https://via.placeholder.com/600x400/050505/00d2ff?text=AWAITING+SOURCE+SIGNAL">
            </div>
        </div>
    </div>
</div>

<script>
    const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models/';
    let faceMatcher = null;
    let lastDetections = [];
    let displaySize = {};

    async function init() {
        const overlay = document.getElementById('loading-overlay');
        try {
            await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);
            await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
            await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
            overlay.innerText = ">> 系統就緒：請上傳影像檔案";
        } catch (e) {
            overlay.innerText = ">> 錯誤：模型載入失敗";
        }
    }

    async function process() {
        const refFile = document.getElementById('refImg').files[0];
        const queryFile = document.getElementById('queryImg').files[0];
        if (!refFile || !queryFile) return;

        document.getElementById('loading-overlay').innerText = ">> 執行生物特徵分析中...";

        // 1. 處理基準
        const refImage = await faceapi.bufferToImage(refFile);
        const refResult = await faceapi.detectSingleFace(refImage).withFaceLandmarks().withFaceDescriptor();
        if (!refResult) return alert("基準圖找不到人臉");
        faceMatcher = new faceapi.FaceMatcher(refResult, 0.6);

        // 2. 處理掃描
        const mainImg = document.getElementById('mainView');
        mainImg.src = URL.createObjectURL(queryFile);

        mainImg.onload = async () => {
            const container = document.getElementById('stage');
            const oldCanvas = container.querySelector('canvas');
            if (oldCanvas) oldCanvas.remove();

            const detections = await faceapi.detectAllFaces(mainImg).withFaceLandmarks().withFaceDescriptors();
            const canvas = faceapi.createCanvasFromMedia(mainImg);
            container.appendChild(canvas);

            displaySize = { width: mainImg.width, height: mainImg.height };
            faceapi.matchDimensions(canvas, displaySize);
            lastDetections = faceapi.resizeResults(detections, displaySize);

            // 渲染表格與繪圖
            renderResults(canvas);
        };
    }

    function renderResults(canvas) {
        const tbody = document.getElementById('resultBody');
        tbody.innerHTML = "";
        const ctx = canvas.getContext('2d');
        document.getElementById('loading-overlay').innerText = `>> 掃描完成：偵測到 ${lastDetections.length} 名對象`;

        lastDetections.forEach((d, i) => {
            const match = faceMatcher.findBestMatch(d.descriptor);
            const similarity = Math.round((1 - match.distance) * 100);
            const isTarget = match.label !== 'unknown';
            const color = isTarget ? '#00d2ff' : '#ff3131';

            // 繪製方框 (矩形)
            const box = d.detection.box;
            const drawBox = new faceapi.draw.DrawBox(box, { 
                label: `${isTarget ? 'TARGET' : 'UNKNOWN'} ${similarity}%`,
                drawStyle: { color: color, lineWidth: 2 }
            });
            drawBox.draw(canvas);

            // 插入表格
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>#${i+1}</td>
                <td style="color:${color}">${isTarget ? '目標人物' : '未知對象'}</td>
                <td>${similarity}%</td>
                <td><button onclick="highlightFace(${i})">追蹤標記</button></td>
            `;
            tr.onclick = () => highlightFace(i);
            tbody.appendChild(tr);
        });
    }

    // 點擊表格閃爍效果
    function highlightFace(index) {
        const container = document.getElementById('stage');
        const oldFlash = document.getElementById('flash-div');
        if (oldFlash) oldFlash.remove();

        const data = lastDetections[index].detection.box;
        const flashDiv = document.createElement('div');
        flashDiv.id = 'flash-div';
        flashDiv.style.position = 'absolute';
        flashDiv.style.left = data.x + 'px';
        flashDiv.style.top = data.y + 'px';
        flashDiv.style.width = data.width + 'px';
        flashDiv.style.height = data.height + 'px';
        flashDiv.style.border = '4px solid #00d2ff';
        flashDiv.style.zIndex = '100';
        flashDiv.classList.add('flash-target');

        container.appendChild(flashDiv);
        setTimeout(() => flashDiv.remove(), 1200);
    }

    document.getElementById('refImg').onchange = process;
    document.getElementById('queryImg').onchange = process;
    init();
</script>

</body>
</html>
